<!DOCTYPE html>
<html>

<head>
    <style>
        .bg1{
            background: url(llama.jpg);
        }

        .bg2{
            background: url(llama2.jpg);
        }
    </style>
  <script type="text/javascript" src="js/jquery/jquery-1.9.0.min.js"></script>
  <script type="text/javascript" src="js/jquery/mousewheel.js"></script>
  <script type="text/javascript" src="js/audiolibjs/audiolib.js"></script>
  <script type="text/javascript" src="js/voice.js"></script>
  <script type="text/javascript" src="js/samples/kick.js"></script>
  <script type="text/javascript" src="js/samples/snare.js"></script>
  <script type="text/javascript" src="js/samples/hat1.js"></script>
  <script type="text/javascript" src="js/samples/hat2.js"></script>
  <script type="text/javascript" src="js/samples/synthraw.js"></script>
  <script type="text/javascript">

var device, freePlay, keyIsDown = false, chorusL, chorusR, envelope, seqVoices = [], voices = [], voiceIds = [],
  wobbleLfo, tempo = 140, wobbleStep = 2, filter, cutoff = 6000, reverb, synthReverb, delay,
  kickSampler, snareSampler, hatSampler, hat2Sampler, synthSampler, tickCounter = 1, beatFractionConst, stepIndex = 100,
    playing = false;

var kickSample = atob(kick);
var snareSample = atob(snare);
var hatSample = atob(hat1);
var hat2Sample = atob(hat2);
var synthSample = atob(synthRaw);

var getFrequency = function(note) {
  if (note === 'C1') return 32.7032;
  if (note === 'D1') return 36.7081;
  if (note === 'Eb1') return 38.8909;
  if (note === 'F1') return 43.6535;
  if (note === 'G1') return 48.9994;
  if (note === 'Ab1') return 51.9131;
  if (note === 'Bb1') return 58.2705;
  if (note === 'C2') return 65.4064; 
  return 0;
};

var buildBassSequenceUI = function(){

  var div = $('#bassSequence');
  var steps = 32;
  var pitches = 9;

  for (var row = 0; row < pitches; row++){
    var newDiv = $('<div>');
    div.prepend(newDiv);
    var label = $('<span>');
    label.text(row.toString());
    newDiv.append(label);
    for (var col = 0; col < steps; col++) {
      var value = "X";
      if (row === 1) {
        value = "C1";
      } else if (row === 2) {
        value = "D1";
      } else if (row === 3) {
        value = "Eb1";
      } else if (row === 4) {
        value = "F1";
      } else if (row === 5) {
        value = "G1";
      } else if (row === 6){
        value = "Ab1";
      } else if (row === 7) {
        value = "Bb1";
      } else if (row === 8) {
        value = "C2";
      }
      var input = $('<input class="bassNote" type="radio" name="' + col + '" value="' + value + '"">');
      newDiv.append(input);
      if (row === 0){
        input.attr('checked', true);
      }
    }
  }


};

var voiceSequence = {
    steps: [ ]
/*        {step: 0, hz: 60, length: 24 },
        {step: 24, hz: 70, length: 8 },
    ]
    */
};

var writeSortedSteps = function(){

  var sorted = voiceSequence.steps.sort(function(a,b){
    return a.step - b.step;
  });

  for (var i = 0; i < sorted.length; i++) {
    var step = sorted[i];
    console.log('step: ' + step.step + ', length: ' + step.length + ' hz: ' + step.hz + ', ignore: ' + step.ignore);
  }

};

var fixSustainedNotes = function (){
  console.log('');
  var sorted = voiceSequence.steps.sort(function(a,b){
    return a.step - b.step;
  });

  for (var i = 0; i < sorted.length; i++) {
    sorted[i].ignore = false;
  }

  for (var i = 0; i < sorted.length; i++){
    var current = sorted[i];
    var nextIndex = i + 1;

    if (nextIndex === sorted.length) {
      break;
    }

    current.length = 1;

    for (var n = nextIndex; n < sorted.length; n++) {
      var next = sorted[n];
      if (next.step === n && next.hz === current.hz) {
        current.length += 1;
        next.ignore = true;
      }
      else {
        break;
      }
    }
  } 

  writeSortedSteps();
}

$(document).ready(function(){

    setInterval(function(){
        if (!playing) return;
        
        if ($('body').attr('class') != 'bg1'){
            $('body').attr('class', 'bg1');
        } else {
            $('body').attr('class', 'bg2');
        }

    }, 428.5);

    buildBassSequenceUI();

    $('.bassNote').click(function (arg) {
      var newStep = {
        step: parseInt($(this).attr('name')),
        hz: getFrequency($(this).val()),
        length: 1,
        ignore: false
      };

      var found = false;
      for (var i = 0; i < voiceSequence.steps.length; i++){
        var existingStep = voiceSequence.steps[i];
        if (existingStep.step === newStep.step) {
          console.log('found');
          existingStep.hz = newStep.hz;
          found = true;
          break;
        }
      }

      if (!found) {
        voiceSequence.steps.push(newStep);
      }

      fixSustainedNotes();
    });

});


var drumSequence = {
  steps: [
    { step: 0, sampler: 'synth' , hz: 440 },
    { step: 16, sampler: 'synth' , hz: 200 },
    { step: 24, sampler: 'synth' , hz: 175 },
    { step: 0, sampler: 'kick', hz: 440 },
    { step: 2, sampler: 'hat', hz: 440 },
    { step: 3, sampler: 'kick', hz: 440 },
    { step: 6, sampler: 'hat2' , hz: 440 },
    { step: 8, sampler: 'snare' , hz: 440 },
    { step: 10, sampler: 'hat' , hz: 440 },
    { step: 11, sampler: 'hat2' , hz: 440 },
    { step: 14, sampler: 'hat2' , hz: 440 },
    { step: 15, sampler: 'hat' , hz: 440 },
    { step: 16, sampler: 'kick' , hz: 440 },
    { step: 19, sampler: 'hat' , hz: 440 },
    { step: 22, sampler: 'hat2' , hz: 440 },
    { step: 23, sampler: 'hat' , hz: 440 },
    { step: 24, sampler: 'snare' , hz: 440 },
    { step: 26, sampler: 'hat' , hz: 440 },
    { step: 27, sampler: 'hat2' , hz: 440 },
    { step: 29, sampler: 'hat2' , hz: 440 },
    { step: 30, sampler: 'hat' , hz: 440 },
    { step: 31, sampler: 'hat2' , hz: 440 },
  ]
};

var audioCallback = function(buffer, channels){
  
    if (!playing) return;

  var sample = 0;
  var kickSampleL = 0;
  var kickSampleR = 0;
  var sampler;
  var s, step;
    var synthL, synthR, v;

  for (var i = 0; i < buffer.length; i+=2) {
    sample = 0;

      tickCounter = tickCounter + beatFractionConst;

      if (tickCounter >= 1){
        tickCounter = 0;

        stepIndex += 1;
        if (stepIndex >= 32){
          stepIndex = 0;
        }

        if (!freePlay) {
          for (s = 0; s < voiceSequence.steps.length; s++) {
            step = voiceSequence.steps[s];
            if (step.step === stepIndex && !step.ignore) {
              var voice = new Voice(device.sampleRate, 0, step.hz);
              voice.fixed = true;
              voice.samplesLeft = step.length / beatFractionConst;
              seqVoices.push(voice);
              wobbleLfo.reset();
            }  
          }
        }

        for (s = 0; s < drumSequence.steps.length; s++){
          step = drumSequence.steps[s];
          if (step.step === stepIndex){
            if (step.sampler === 'kick'){
              kickSampler.noteOn(step.hz);
            } else if (step.sampler === 'snare'){
              snareSampler.noteOn(step.hz);
            } else if (step.sampler === 'hat'){
                hatSampler.noteOn(step.hz);
            } else if (step.sampler === 'hat2'){
                hat2Sampler.noteOn(step.hz);
            } else if (step.sampler === 'synth'){
                synthSampler.noteOn(step.hz);
            }
          }
        }
      }

    // remove expired voices
    for (v = seqVoices.length - 1; v >= 0; v--){
        if (seqVoices[v].finished){
            seqVoices.splice(v, 1);
        }
    }

    for (v = voices.length - 1; v >= 0; v--){
        if (voices[v].finished){
            voices.splice(v);
            voiceIds.splice(v);
        }
    }

    if (freePlay) {

        for (v = 0; v < voices.length; v++){
            voices[v].generate();
            sample += voices[v].getMix() / voices.length;
        }
    } else {
        for (v = 0; v < seqVoices.length; v++){
            seqVoices[v].generate();
            sample += seqVoices[v].getMix();
        }
    }

    if (wobbleLfo.frequency !== 0){
        wobbleLfo.generate();
        filter.cutoff = cutoff * ((wobbleLfo.getMix() + 1) * 0.5);
    }

    filter.pushSample(sample);
    sample = filter.getMix();

    kickSampler.generate();
    kickSampleL = kickSampler.getMix(0) * .3;
    kickSampleR = kickSampler.getMix(1) * .3;

    snareSampler.generate();
    kickSampleL += snareSampler.getMix(0) * .3;
    kickSampleR += snareSampler.getMix(1) * .3;

    hatSampler.generate();
    kickSampleL += hatSampler.getMix(0) * .2;
    kickSampleR += hatSampler.getMix(1) * .2;

    hat2Sampler.generate();
    kickSampleL += hat2Sampler.getMix(0) * .15;
    kickSampleR += hat2Sampler.getMix(1) * .15;

    synthSampler.generate();
    synthL = synthSampler.getMix(0) * .3;

    synthReverb.pushSample(synthL, 0);
    synthReverb.pushSample(synthL, 1);

    reverb.pushSample(sample, 0);
    reverb.pushSample(sample, 1);

    buffer[i] = reverb.getMix(0) + synthReverb.getMix(0) + kickSampleL;
    buffer[i+1] = reverb.getMix(1) + synthReverb.getMix(1) + kickSampleR;


  }
}

window.addEventListener('load', function(){

    device = audioLib.AudioDevice(audioCallback, 2);
    wobbleLfo = audioLib.Oscillator(device.sampleRate, 0);
    wobbleLfo.waveShape = 'sine';

    filter = audioLib.IIRFilter(device.sampleRate, cutoff);
    bandPass = audioLib.IIRFilter(device.sampleRate, 3000, 0.5, 2);

    reverb = audioLib.Reverb(device.sampleRate, 2, .5, .5, .6);
    synthReverb = audioLib.Reverb(device.sampleRate, 2, .8, .5, .8);

    kickSampler = audioLib.Sampler(device.sampleRate);
    kickSampler.loadWav(kickSample, true);
    snareSampler = audioLib.Sampler(device.sampleRate);
    snareSampler.loadWav(snareSample, true);
    hatSampler = audioLib.Sampler(device.sampleRate);
    hatSampler.loadWav(hatSample, true);
    hat2Sampler = audioLib.Sampler(device.sampleRate);
    hat2Sampler.loadWav(hat2Sample, true);
    synthSampler = audioLib.Sampler(device.sampleRate);
    synthSampler.loadWav(synthSample, true);

    beatFractionConst = 1 / device.sampleRate * tempo / 60;
    beatFractionConst = beatFractionConst * 4;

    $(document).keydown(function(k){

    if (k.which === 38) {
      if (wobbleLfo.waveShape === 'sine') {
        wobbleLfo.waveShape = 'invSawtooth';
      } else if (wobbleLfo.waveShape === 'invSawtooth'){
        wobbleLfo.waveShape = 'sawtooth';
      } else if (wobbleLfo.waveShape === 'sawtooth') {
        wobbleLfo.waveShape = 'sine';
      }
    } else {
            if (voiceIds.indexOf(k.which) === -1){
                var voice = new Voice(device.sampleRate, k.which, k.which * 1.5);
                voices.push(voice);
                voiceIds.push(k.which);
            }
      }
      
    });

    $(document).keyup(function(k){
      if (voiceIds.indexOf(k.which) !== -1){
            for (var i = 0; i < voices.length; i++){
                if (voices[i].id === k.which){
                    voices[i].stop();
                }
            }
        }     
    });

    $('#playButton').click(function(){
        playing = !playing;
    });

    $('#freePlayCheckbox').click(function(){
        freePlay = $('#freePlayCheckbox').is(':checked');
        seqVoices = [];
    });

    processWobbleStep();
    
}, true);

var processWobbleStep = function(){
    wobbleLfo.frequency = tempo / 60 * wobbleStep * 0.5;
    filter.cutoff = cutoff;
};

$(document).mousewheel(function(event, delta, deltaX, deltaY) {
    wobbleStep += delta;

    while (wobbleStep === 5 || wobbleStep === 7) {
      wobbleStep += delta;
    }

    wobbleStep = wobbleStep < 0 ? 0 : wobbleStep;
    wobbleStep = wobbleStep > 8 ? 8 : wobbleStep;
    processWobbleStep();
});

  </script>
  
  <style>
  body{
    font-family: Helvetica, Arial, sans-serif;
  }
  </style>
</head>

<body class="bg1">
  <ul>
    <li>Press any key on the keyboard to play a note. Keys don't really map to a real note yet. </li>
    <li>Use the mouse wheel to increase or decrease wobble speed.</li>
    <li>Use the up arrow key to cycle through wobble types (sine, sawtooth, and inverted sawtooth).</li>
  </ul>

    <p>
        <button id="playButton">play/pause</button>
    </p>

    <p>
        <input type="checkbox" id="freePlayCheckbox" />&nbsp;Free play with keyboard
    </p>

    <div id="bassSequence"></div>
</body>
</html>